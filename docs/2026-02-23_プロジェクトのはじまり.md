# プロジェクトのはじまり

2026-02-23、Nikki Appの開発を始動した。

## 構成の検討

費用をなるべく抑えつつウェブアプリケーションをデプロイしたい、という前提で複数の構成案を比較検討した。

- **デプロイ先**: Vercel / Cloudflare Workers / Fly.io を比較 → Vercel を選択（開発体験がよく、無料枠で十分）
- **データベース**: Neon / Supabase / Edge SQLite (Turso, D1) を比較 → Neon (Postgres) を選択（自由度が高く、コストも抑えやすい）
- **画像ストレージ**: Vercel Blob / Cloudflare R2 / Uploadthing を比較 → Cloudflare R2 を選択（無料枠10GB・帯域無料で圧倒的。どの構成でもR2が最適という結論に）
- **ORM**: Prisma / Drizzle を比較 → Prisma を選択（直感的なスキーマ定義、マイグレーション管理が充実）
- **認証**: Auth.js (NextAuth) + Google OAuth

## Next.js プロジェクトの初期化

- `create-next-app@latest` で生成（TypeScript, Tailwind CSS v4, App Router, Turbopack, pnpm）
- 開発サーバーのポートを `30303` に設定（他のローカルプロジェクトとの競合を回避）
- Caddy のリバースプロキシ設定を追加し、 https://nikki.lvh.me でローカル開発環境にアクセスできるようにした

## データベース設計 (Prisma + Neon)

Prisma ORMを導入し、Neonアダプター (`@prisma/adapter-neon`) で接続。Neonプロジェクトはシンガポールリージョン (ap-southeast-1) に作成した。

### スキーマの設計判断

- **Blockのコンテンツタイプ**: 当初はSTI（Single-Table Inheritance）で設計したが、以前のRails版 (day_by_block) のスキーマを参考にポリモーフィック関連方式に変更した。タイプごとに別テーブル（BlockText, BlockImage, BlockLink, BlockQuote）を持ち、Block テーブルの `blockElementType` + `blockElementId` で参照する。各タイプのフィールドをNOT NULLで厳密に管理でき、新タイプ追加時もテーブル追加だけで済む。
- **Block → Day**: `dayId` nullable。作成直後はどのDayにも属さず、後でDayに束ねる。`position` で Day 内の並び順を管理。
- **Reblock**: Block の自己参照 (`reblockSourceId`)。元Blockが削除されてもReblockは残る (`onDelete: SetNull`)。
- **Hashtag**: Prisma の暗黙的多対多リレーション。
- **Day**: `@@unique([userId, date])` で1ユーザー・1日・1Day を DB 層で強制。`DayStatus` enum で DRAFT/PUBLISHED を管理。
- **Auth.js互換**: 公式 Prisma adapter のスキーマ（User, Account, Session, VerificationToken, Authenticator）をそのまま採用し、User にアプリ固有フィールド（`userName`, `displayName`, `bio`）を追加。
- **userName**: Auth.js の Google ログインでは初回ユーザー作成時に userName が設定されないため、optional (`String?`) にした。`createUser` イベントで cuid ベースの値を自動生成する。

## 認証 (Auth.js + Google OAuth)

- `next-auth` v5 (beta) + `@auth/prisma-adapter` を導入
- `src/auth.ts` にAuth.js設定、`src/app/api/auth/[...nextauth]/route.ts` にAPIルートを作成
- Google Cloud Console で OAuth クライアントを作成し、コールバック URL を設定
- トップページにログイン状態の表示（名前・メール）とログイン/ログアウトボタンを実装
- ローカルとVercel本番の両方でGoogleログインの動作を確認済み

## Vercel デプロイ

- GitHub リポジトリ (junebako/nikki-app) を Vercel に接続
- `postinstall` スクリプトに `prisma generate` を追加（ビルド時に Prisma Client を生成するため）
- `pnpm.onlyBuiltDependencies` に `@prisma/engines` と `prisma` を追加（pnpmのビルドスクリプト許可）
- Vercel の環境変数に `DATABASE_URL`, `AUTH_URL`, `AUTH_SECRET`, `AUTH_GOOGLE_ID`, `AUTH_GOOGLE_SECRET` を設定
- https://nikki-app-nine.vercel.app で本番デプロイ完了、Googleログイン動作確認済み
