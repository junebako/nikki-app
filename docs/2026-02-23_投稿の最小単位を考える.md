# 投稿の最小単位を考える

## 結論

**Piece 1モデル + text カラム（Markdown）に一本化する。**

投稿の最小単位の名前は **Piece**（かけら）。「日々のかけら」を小さく書き溜めて、1日分をまとめて公開する、というコンセプトに合う。Block も候補にあったが（スペルミスしにくい、わかりやすい）、意味のきれいさで Piece を選んだ。

## 背景

以前の Rails 版（day_by_block）と同じ設計方針で、ポリモーフィック関連方式（Block + BlockText / BlockImage / BlockLink / BlockQuote）を採用していた。しかし実際の投稿を考えると：

- 1つの投稿にリンクを2つ入れたい
- 1つの投稿に画像を2つ載せたい
- 引用は Markdown の `>` とリンクで表現できる

といったケースがあり、ブロック要素ごとにテーブルを分ける意味が薄い。テキストの中に自由に書ける方が自然。

## Piece モデル

```
Piece
├── id
├── userId
├── text (Markdown)
├── dayId (nullable)
├── position
├── originalPieceId (nullable)
├── hashtags (多対多)
└── timestamps
```

## 廃止するもの

- Block / BlockText / BlockImage / BlockLink / BlockQuote（5モデル）
- `blockElementType` / `blockElementId`（ポリモーフィック関連）

## 独自記法: embed

Markdown ベースに1つだけ独自記法を取り入れる。

```
[[https://example.com/some-page]]
```

- ダブル括弧で URL を囲むと embed 展開される
- 保存時はプレーンテキストのまま保持し、表示時にパースしてリッチなカード表示に変換する

## 今後の検討

- embed の展開ルール（YouTube → 動画、X → ツイート、汎用 → OGP カード、など）
- OGP 情報のキャッシュ戦略
- 画像アップロード（Cloudflare R2）
